---
title: "Multistage Likelihood"
author: "KÃ­nh"
output:
    html_document:
        toc: true
        toc_float: true
        code_folding: hide
always_allow_html: true
---

```{r setup, include=F}
here::i_am("code/prep.Rmd")
source('~/Documents/libs.r')

library(rdhs)
tabyl <- function(dat, ...) janitor::tabyl(dat, ..., show_missing_level = FALSE)
set.seed(1)
```

## Sample Data

Pull with `rdhs`

```{r adam, eval = F}
set_rdhs_config(
    email = "ath19@ic.ac.uk",
    project = "Statistics and Machine Learning for HIV", password_prompt = T
)
# 1
datasets <- dhs_datasets("MW", fileFormat = "flat", fileType = c("IR")) %>%
    filter(SurveyYear %in% 2015:2017) %>%
    mutate(sex = if_else(FileType == "Individual Recode", "female", "male"))
downloads <- get_datasets(datasets$FileName)
```

```{r dhs_pull}
datasets <- readRDS(here("data/dhs_datasets.rds"))
downloads <- readRDS(here("data/dhs_downloads.rds"))
names(downloads)

x <- 1 # adapt from multiple datasets
o <- readRDS(downloads[[x]]) %>%
    as_tibble() %>%
    mutate(lab = datasets$SurveyId[x])
```

Extract and converting date time 

```{r prep}
dta <- o %>%
    select(
        psu = v021, strata = v023, weights = v005, dob = v011, doi = v008, lab,
        afs = v531, 
        marriage_age = v511,
        n_union = v503,
        month_1st_union = v507,
        year_1st_union = v508,
        cmc_uninon = v509,
        marital_status = v501,
        union_married = v502,
        ever_in = v535
    ) %>%
    mutate(
        marriage_age =  if_else(is.na(marriage_age), 0L, marriage_age),
        marriage_age2 = (cmc_uninon - dob) / 12,
        iso = substr(lab, 1, 2),
        yob = cmc_to_year(dob), svy = cmc_to_year(doi),
        age = svy - yob, sex = datasets$sex[x]
    )

#' Data cleaning
#'
dta %<>% filter(haven::zap_label(afs) <= age)
dta %<>% filter(marriage_age <= age)
dta %<>% filter(!(marital_status != 0 & afs == 0))
dta <- dta |>
    mutate(across(c(marital_status, n_union), haven::as_factor)) %>%
    mutate(marital_status = forcats::fct_recode(
        marital_status,
        separated = "no longer living together/separated",
        union = "living with partner"
    ))
#' remove those had more than once union with less than 3 years ()
#' get this back when change to smaller time spliting duration
# dta %<>%
    # filter(!( n_union == 'more than once' & age - marriage_age < 3 ))
```

Calculate needed indcator for likelihood

```{r likelihood_prep}
dta %>%
    select(afs, aam = marriage_age, age, u = n_union, ms = marital_status) %>% 
    mutate(ms = if_else(ms == "union", "married", ms)) %>% 
    mutate(afs = if_else(afs != 0 & afs >= aam, aam, afs)) %>% # remove VX if VM
    mutate(
        VV = case_when(afs != 0 ~ afs - 1, otherwise ~ age - 1),
        VX = case_when(afs != 0 & afs != aam ~ afs, otherwise ~ -2908),
        VM = case_when(afs != 0 & afs == aam ~ aam, otherwise ~ -2908),
        XX = case_when(afs != 0 & aam != 0 & afs != aam ~ aam - afs, otherwise ~ -2908),
        XM = case_when(aam != 0 & afs != aam ~ aam, otherwise ~ -2908),
        MM = case_when(aam != 0 & u == "once" & ms == "married" ~ age - aam, otherwise ~ -2908),
        MJ = case_when(
            aam != 0 & !(u == "once" & ms == "married") ~ aam,
            otherwise ~ -2908, # never had sex
            ),
        delta = if_else(MJ > 0, age - aam + 1, -2908), 
        J = case_when(
            delta > 0 & ms == "separated" ~ 4,
            delta > 0 & ms == "divorced" ~ 5,
            delta > 0 & ms == "widowed" ~ 6,
            delta > 0 & ms == "married" ~ 7,
            otherwise ~ -2908
            )
    ) %>% 
    allot(d)

d %>% 
    count(age, afs, aam, VV, VX, XX, XM, VM, MM, MJ, J, delta) %>% 
    rename(count = n) %>% 
    saveRDS(here::here('data/d_agg.rds'))
```

```
